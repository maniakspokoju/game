<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Gra QR z Quizem - Poprawiona</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body { font-family: Arial; text-align: center; padding: 20px; }
  #timer { font-size: 48px; margin: 10px; }
  #nextCode { font-size: 48px; font-weight: bold; color: red; margin:10px; }
  #history { font-size: 32px; margin: 10px; }
  #points { font-size: 32px; margin: 10px; }
  button { font-size: 32px; margin: 5px; padding: 30px 30px; }
  #quiz { margin: 20px; }
</style>
</head>
<body>

<h1>Gra QR - 8.8.2</h1>

<div id="screen-init">
  <p>Zeskanowałeś kod startowy. Czy jesteś gotowy?</p>
  <button id="startBtn">START</button>
</div>

<div id="screen-game" style="display:none;">
  <div id="timer">--</div>
  <div id="nextCode"></div>
  <div id="history"></div>
  <div id="points">Punkty: 0</div>
  <div id="quiz"></div>
  <div id="reader" style="margin-top: 20px;"></div>
</div>

<div id="screen-end" style="display:none;">
  <h2 id="endMessage"></h2>
</div>

<script>
const CODES = ["A","B","C"];
let history = [];
let historyIndex = -1;
let currentCode = null;
let lastCode = null;
let points = 0;
let maxPoints = 5;

let gameState = "INIT"; // INIT | QUIZ | SCAN | END
let html5QrCode = null;
let timer = null;
let timeLeft = 0;

const startBtn = document.getElementById("startBtn");
const screenInit = document.getElementById("screen-init");
const screenGame = document.getElementById("screen-game");
const screenEnd = document.getElementById("screen-end");
const nextCodeEl = document.getElementById("nextCode");
const historyEl = document.getElementById("history");
const pointsEl = document.getElementById("points");
const quizEl = document.getElementById("quiz");
const endMessageEl = document.getElementById("endMessage");

// START GRY
startBtn.addEventListener("click", () => {
  gameState = "QUIZ";
  screenInit.style.display = "none";
  screenGame.style.display = "block";
  nextRound();
});

// GENEROWANIE NASTĘPNEGO KODU
function generateNextCode() {
  const available = CODES.filter(c => c !== lastCode);
  currentCode = available[Math.floor(Math.random() * available.length)];
  lastCode = currentCode;
}

// QUIZ
function generateQuiz() {
  document.getElementById("reader").style.display = "none";
  const a = rand(), b = rand(), c = rand(), d = rand();
  const ops = ["+","-","*","/"];
  const op1 = ops[rand(0,3)];
  const op2 = ops[rand(0,3)];

  const left = evalExpr(a,op1,b);
  const right = evalExpr(c,op2,d);

  const correct = left > right ? ">" : "<";

  quizEl.innerHTML = `
    <h2>${a} ${op1} ${b} ? ${c} ${op2} ${d}</h2>
    <button onclick="answerQuiz('<')">&lt;</button>
    <button onclick="answerQuiz('>')">&gt;</button>
  `;

  function answerQuiz(choice){
    if(choice === correct){
      startScanPhase();
    } else {
      failRound();
    }
  }
  window.answerQuiz = answerQuiz; // expose function
}

// SCAN
function startScanPhase() {
  gameState = "SCAN";
  quizEl.innerHTML = "";
  document.getElementById("reader").style.display = "block";
  if(historyIndex < points) {
    generateNextCode(); // ustawiamy nowy kod dopiero teraz
  }
  nextCodeEl.innerText = `Skanuj kod: ${currentCode}`;
  updateHistoryDisplay();
  startTimer(5);
  if(html5QrCode) html5QrCode.stop().catch(()=>{});
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 700 },
    onScanSuccess,
    ()=>{}
  );
}

function onScanSuccess(decodedText){
  const url = new URL(decodedText, window.location.href);
  const code = url.searchParams.get("code");
  const start = url.searchParams.get("start");

  if(start==="1"){
    endGame("Gra zakończona kodem STOP.");
    return;
  }

  if(gameState !== "SCAN") return;

  if(code === currentCode){
    points++;
    historyIndex++;
    history[historyIndex] = currentCode; // zapisujemy aktualny skan w historii
    pointsEl.innerText = `Punkty: ${points}`;

    updateHistoryDisplay();       // historia od razu aktualna
    
    nextRound();
  }
}

// KOLEJNA RUNDA
function nextRound(){
  stopTimer();
  if(points>=maxPoints){
    endGame("Wygrana! Zdobyłeś 5 punktów.");
    return;
  }
  generateQuiz();
}

// FAIL (zła odpowiedź w quizie lub timeout)
function failRound(){
  stopTimer();
  points = Math.max(0, points-1);
  pointsEl.innerText = `Punkty: ${points}`;

  if(historyIndex>=0){
    currentCode = history[historyIndex]; // cofamy do poprzedniego skanu
    historyIndex--; // ustawienie indeksu tak, aby kolejny sukces posuwał go prawidłowo
    startScanPhase();
  } else {
    endGame("Gra zakończona, nie udało się zdobyć punktów.");
  }
}

// TIMER
function startTimer(seconds){
  timeLeft = seconds;
  document.getElementById("timer").textContent = timeLeft;
  timer = setInterval(()=>{
    timeLeft--;
    document.getElementById("timer").textContent = timeLeft;
    if(timeLeft<=0){
      failRound();
    }
  },1000);
}

function stopTimer(){
  clearInterval(timer);
  timer=null;
}

// HISTORIA
function updateHistoryDisplay(){
  historyEl.innerText = "Historia: " + history.slice(0, historyIndex+1).join(" > ");
}

// KONIEC GRY
function endGame(msg){
  gameState="END";
  stopTimer();
  if(html5QrCode) html5QrCode.stop().catch(()=>{});
  screenGame.style.display="none";
  screenEnd.style.display="block";
  endMessageEl.innerText = msg;
}

// POMOCNICZE
function rand(min=1,max=9){return Math.floor(Math.random()*(max-min+1))+min;}
function evalExpr(a,op,b){if(op==="/"&&b===0)return Infinity; return eval(`${a}${op}${b}`);}
</script>

</body>
</html>









