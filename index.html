<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Gra QR + Quiz - etap 8</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .info { font-size: 3em; margin: 10px 0; }
  #target { color: red; font-weight: bold; }
  #reader { width: 300px; margin-top: 20px; }
  button { font-size: 2em; margin: 10px; padding: 10px 20px; }
</style>
</head>

<body>

<h1>Gra QR + Quiz - etap 8</h1>

<div id="screen-init">
  <p class="info">Gotowy?</p>
  <button id="startBtn">START</button>
</div>

<div id="screen-quiz" style="display:none;">
  <p class="info" id="quizQuestion"></p>
  <button onclick="answerQuiz('<')">&lt;</button>
  <button onclick="answerQuiz('>')">&gt;</button>
</div>

<div id="screen-game" style="display:none;">
  <p class="info">Zeskanuj kod: <span id="target"></span></p>
  <p class="info">Czas: <span id="timer"></span></p>
  <p class="info">Punkty: <span id="points">0</span></p>
  <p class="info" id="history"></p>
  <p class="info" id="status"></p>
  <div id="reader"></div>
</div>

<div id="screen-end" style="display:none;">
  <h2 class="info" id="endMessage"></h2>
</div>

<script>
/* ================== STAŁE ================== */
const CODES = ["A","B","C"];
const SCAN_TIME = 5;
const WIN_POINTS = 5;

/* ================== STAN ================== */
let currentTarget = null;
let history = [];
let points = 0;
let timeLeft = SCAN_TIME;
let timerInterval = null;
let html5QrCode = null;
let correctQuizAnswer = null;

/* ================== ELEMENTY ================== */
const targetEl = document.getElementById("target");
const timerEl = document.getElementById("timer");
const pointsEl = document.getElementById("points");
const historyEl = document.getElementById("history");
const statusEl = document.getElementById("status");

/* ================== UI ================== */
function show(screen) {
  ["screen-init","screen-quiz","screen-game","screen-end"]
    .forEach(id => document.getElementById(id).style.display = "none");
  document.getElementById(screen).style.display = "block";
}

function updateHistory() {
  historyEl.innerText = "Historia: " + history.join(" → ");
}

/* ================== ZAKOŃCZENIE ================== */
function endGame(msg) {
  clearInterval(timerInterval);
  if (html5QrCode) {
    html5QrCode.stop().catch(()=>{});
  }
  show("screen-end");
  document.getElementById("endMessage").innerText = msg;
}

/* ================== COFANIE ================== */
function rollback() {
  clearInterval(timerInterval);

  points = Math.max(0, points - 1);
  pointsEl.innerText = points;

  history.pop();

  if (history.length === 0) {
    endGame("Koniec gry – brak możliwości cofania.");
    return;
  }

  currentTarget = history[history.length - 1];
  targetEl.innerText = currentTarget;
  updateHistory();

  startScanPhase();
}

/* ================== TIMER ================== */
function startTimer() {
  clearInterval(timerInterval);
  timeLeft = SCAN_TIME;
  timerEl.innerText = timeLeft;

  timerInterval = setInterval(() => {
    timeLeft--;
    timerEl.innerText = timeLeft;
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      rollback();
    }
  }, 1000);
}

/* ================== SKANER ================== */
function startScanner() {
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    text => {
      const url = new URL(text, window.location.href);
      const code = url.searchParams.get("code");

      if (code === currentTarget) {
        clearInterval(timerInterval);
        html5QrCode.stop().then(() => {
          points++;
          pointsEl.innerText = points;
          statusEl.innerText = "DOBRZE!";

          if (points >= WIN_POINTS) {
            endGame("Wygrana!");
          } else {
            nextTarget(); // ZAWSZE quiz
          }
        });
      } else {
        statusEl.innerText = "Szukaj dalej...";
      }
    }
  );
}

/* ================== FAZA SKANOWANIA ================== */
function startScanPhase() {
  show("screen-game");
  statusEl.innerText = "";
  startTimer();
  startScanner();
}

/* ================== QUIZ ================== */
function generateQuiz() {
  let left, right;
  const ops = ["+","-","*","/"];

  do {
    const a = Math.floor(Math.random()*9)+1;
    const b = Math.floor(Math.random()*9)+1;
    const c = Math.floor(Math.random()*9)+1;
    const d = Math.floor(Math.random()*9)+1;
    const op1 = ops[Math.floor(Math.random()*4)];
    const op2 = ops[Math.floor(Math.random()*4)];

    left = eval(`${a}${op1}${b}`);
    right = eval(`${c}${op2}${d}`);

    correctQuizAnswer = left > right ? ">" : "<";
    document.getElementById("quizQuestion").innerText =
      `${a} ${op1} ${b}  ?  ${c} ${op2} ${d}`;
  } while (left === right);
}

function answerQuiz(ans) {
  show("screen-game");
  if (ans !== correctQuizAnswer) {
    rollback();
  } else {
    startScanPhase();
  }
}

/* ================== NOWY CEL ================== */
function nextTarget() {
  if (html5QrCode) {
    html5QrCode.stop().catch(()=>{});
  }

  const available = CODES.filter(c => c !== currentTarget);
  currentTarget = available[Math.floor(Math.random()*available.length)];

  history.push(currentTarget);
  targetEl.innerText = currentTarget;
  updateHistory();

  show("screen-quiz");
  generateQuiz();
}

/* ================== START ================== */
document.getElementById("startBtn").onclick = () => {
  show("screen-quiz");
  nextTarget();
};
</script>

</body>
</html>
