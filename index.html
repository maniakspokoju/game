<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Mini Gra QR</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #qr-number { font-size: 24px; font-weight: bold; margin: 10px 0; }
    #message { color: red; margin: 10px 0; }
    #points { margin: 10px 0; font-weight: bold; }
    button { padding: 5px 10px; margin: 5px 0; }
    #reader { width: 300px; margin-top: 10px; display: none; }
  </style>
</head>
<body>

<h1>Mini Gra QR</h1>

<div id="status">Gotowy do startu?</div>
<button id="start-btn">Start</button>

<div id="qr-number"></div>
<div id="message"></div>
<div id="points">Punkty: 0</div>

<button id="scan-btn" style="display:none;">Otwórz aparat / Skanuj QR</button>
<div id="reader"></div>

<script>
const allCodes = ["A", "B", "C"];
let activeCode = null;
let history = [];
let currentIndex = -1;
let scored = new Set();
let points = 0;
let timer = null;
const SCAN_TIME = 10000; // 10 sekund
const MAX_POINTS = 5;

const statusDiv = document.getElementById("status");
const qrDiv = document.getElementById("qr-number");
const messageDiv = document.getElementById("message");
const pointsDiv = document.getElementById("points");
const startBtn = document.getElementById("start-btn");
const scanBtn = document.getElementById("scan-btn");
const readerDiv = document.getElementById("reader");

function startGame() {
  history = [];
  scored = new Set();
  points = 0;
  currentIndex = -1;
  pointsDiv.innerText = `Punkty: ${points}`;
  statusDiv.innerText = "Gra wystartowała!";
  nextCode();
  scanBtn.style.display = "inline-block";
}

function nextCode() {
  clearTimeout(timer);

  // Losowanie kolejnego kodu różnego od aktualnego
  const available = allCodes.filter(c => c !== activeCode);
  activeCode = available[Math.floor(Math.random() * available.length)];

  // Dodanie do historii
  history.push(activeCode);
  currentIndex = history.length - 1;

  qrDiv.innerText = `Skanuj kod: ${activeCode}`;
  messageDiv.innerText = "";
  
  // Start 10s timera
  timer = setTimeout(() => {
    messageDiv.innerText = "Czas minął! Wracasz do poprzedniego kodu.";
    backToPreviousCode();
  }, SCAN_TIME);
}

function backToPreviousCode() {
  if (currentIndex > 0) {
    currentIndex--;
    activeCode = history[currentIndex];
    qrDiv.innerText = `Wracasz do kodu: ${activeCode}`;
    messageDiv.innerText = "Skanuj ponownie!";
    timer = setTimeout(() => {
      messageDiv.innerText = "Czas minął ponownie! Wracasz jeszcze dalej.";
      backToPreviousCode();
    }, SCAN_TIME);
  } else {
    qrDiv.innerText = "Jesteś na początku gry.";
    messageDiv.innerText = "";
  }
}

function handleScan(code) {
  if (code === activeCode) {
    clearTimeout(timer);
    messageDiv.innerText = "Brawo! Poprawny kod.";
    if (!scored.has(code)) {
      points++;
      scored.add(code);
      pointsDiv.innerText = `Punkty: ${points}`;
    }
    if (points >= MAX_POINTS || code === "START") {
      endGame();
    } else {
      nextCode();
    }
  } else {
    messageDiv.innerText = "Szukaj dalej...";
  }
}

function endGame() {
  clearTimeout(timer);
  qrDiv.innerText = "";
  scanBtn.style.display = "none";
  messageDiv.innerText = `Koniec gry! Zdobyte punkty: ${points}`;
}

// --- Skaner ---
function startScanner() {
  readerDiv.style.display = "block";
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      handleScan(qrCodeMessage);
    },
    errorMessage => { /* ignorujemy błędy */ }
  ).catch(err => alert("Nie udało się uruchomić skanera: " + err));
}

// --- Eventy ---
startBtn.addEventListener("click", startGame);
scanBtn.addEventListener("click", startScanner);
</script>

</body>
</html>
