<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Mini gra QR</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #reader { width: 100%; max-width: 400px; margin-top: 15px; }
    button { padding: 10px 20px; font-size: 16px; }
    .info { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

<h1>Mini gra QR</h1>

<div id="screen-init">
  <p>Zeskanowałeś kod startowy.</p>
  <p>Czy jesteś gotowy?</p>
  <button id="startBtn">START</button>
</div>

<div id="screen-game" style="display:none;">
  <p class="info" id="targetInfo"></p>
  <p class="info" id="status"></p>
  <p>Punkty: <span id="points">0</span></p>
  <div id="reader"></div>
</div>

<div id="screen-end" style="display:none;">
  <h2 id="endMessage"></h2>
</div>

<script>
const CODES = ["A", "B", "C"];
let gameState = "INIT";
let currentTarget = null;
let lastTarget = null;
let points = 0;

const startBtn = document.getElementById("startBtn");
const targetInfo = document.getElementById("targetInfo");
const status = document.getElementById("status");
const pointsEl = document.getElementById("points");
const screenInit = document.getElementById("screen-init");
const screenGame = document.getElementById("screen-game");
const screenEnd = document.getElementById("screen-end");
const endMessage = document.getElementById("endMessage");

let html5QrCode;
let scanTimeout;

// Funkcja losująca kolejny kod do zeskanowania
function pickNextTarget() {
  const available = CODES.filter(c => c !== lastTarget);
  const next = available[Math.floor(Math.random() * available.length)];
  lastTarget = next;
  currentTarget = next;
  targetInfo.innerText = `Zeskanuj kod: ${currentTarget}`;
  status.innerText = "";
  resetScanTimer();
}

// Funkcja kończąca grę
function endGame(message) {
  gameState = "FINISHED";
  screenGame.style.display = "none";
  screenEnd.style.display = "block";
  endMessage.innerText = message;
  if (html5QrCode) html5QrCode.stop();
  clearTimeout(scanTimeout);
}

// Włączenie skanera
function startScanner() {
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 300 },
    text => {
      const scannedText = text.toUpperCase();
      // Obsługa kodu START
      if (scannedText === "START" && gameState === "PLAYING") {
        endGame("Gra zakończona kodem STOP.");
        return;
      }
      if (gameState !== "PLAYING") return;

      if (scannedText === currentTarget) {
        points++;
        pointsEl.innerText = points;
        status.innerText = "DOBRZE!";
        clearTimeout(scanTimeout); // zatrzymujemy licznik
        if (points >= 5) {
          endGame("Wygrana! Zdobyłeś 5 punktów.");
        } else {
          pickNextTarget();
        }
      } else {
        status.innerText = "Szukaj dalej...";
      }
    },
    () => {}
  ).catch(err => alert("Nie udało się uruchomić skanera: " + err));
}

// Prosty timer 10 sekund na skan (do dalszej implementacji cofania)
function resetScanTimer() {
  clearTimeout(scanTimeout);
  scanTimeout = setTimeout(() => {
    status.innerText = "Czas minął! Wróć do poprzedniego kodu.";
    // Tutaj później dodamy mechanikę cofania
  }, 10000);
}

// Obsługa startu gry
startBtn.addEventListener("click", () => {
  gameState = "PLAYING";
  screenInit.style.display = "none";
  screenGame.style.display = "block";
  pickNextTarget();
  startScanner();
});
</script>

</body>
</html>
